window.onload = async () => {
  const manifestUrl = 'https://github.com/pedramhatef/my-twa/blob/main/public/tonconnect-manifest.json';
  console.log('Using manifest URL:', manifestUrl);

  try {
    // Fetch the manifest to check its content before initializing TonConnect
    const manifestResponse = await fetch(manifestUrl);
    if (!manifestResponse.ok) {
      throw new Error(`Failed to fetch manifest. Status: ${manifestResponse.status}`);
    }

    const manifest = await manifestResponse.json();
    console.log('Fetched manifest content:', manifest);

    // Validate required fields in the manifest
    if (!manifest.name || !manifest.url || !manifest.icons) {
      throw new Error('Manifest is missing required fields: name, url, or icons');
    }
  } catch (error) {
    console.error('Error loading or validating manifest:', error.message);
    return; // Stop execution if manifest is invalid
  }

  try {
    const connector = new TonConnectSDK.TonConnect({ manifestUrl });
    window.connector = connector; // For experimenting in browser console

    const walletsList = await connector.getWallets();
    console.log('Available wallets:', walletsList);

    const unsubscribe = connector.onStatusChange(walletInfo => {
      console.log('Connection status changed:', walletInfo);
    });

    connector.restoreConnection();

    const buttonsContainer = document.querySelector('#tonconnect-buttons');

    for (const wallet of walletsList) {
      const connectButton = document.createElement('button');
      connectButton.innerText = `Connect with ${wallet.name}`;

      if (wallet.embedded) {
        connectButton.classList.add('featured');
      }

      connectButton.onclick = () => {
        connectButton.disabled = true;

        if (wallet.embedded || wallet.injected) {
          console.log('Connecting with embedded/injected wallet:', wallet);
          connector.connect({ jsBridgeKey: wallet.jsBridgeKey });
        } else if (wallet.bridgeUrl) {
          console.log('Connecting with universal link:', wallet.universalLink);
          console.log('Bridge URL:', wallet.bridgeUrl);

          connector.connect({
            universalLink: wallet.universalLink,
            bridgeUrl: wallet.bridgeUrl,
          });
        } else {
          console.error('Wallet does not support any connection method:', wallet);
        }
      };

      buttonsContainer.appendChild(connectButton);
    }
  } catch (error) {
    console.error('Error initializing TonConnect:', error);
  }
};
